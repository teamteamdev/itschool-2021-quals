# Устаревшая сессия: Write-up

Первое, что можно сделать — попытаться зайти на сайт с сессией, которая дана в условии. Однако, как и написано в задании, сайт сообщает, что cookie-файл истёк и предлагает авторизоваться заново.

Формат значения немного напоминает base64. Действительно, `eyJ0e...` — это начало base64-закодированного JSON-объекта. Однако, в алфавите base64 нет точки. Давайте попробуем раскодировать фрагменты по частям.

* `eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9` → `{"typ":"JWT","alg":"ES256"}`
* `eyJzdWIiOiJYZWtLZWtBbm9uMTMzNyIsImlhdCI6MTYzMDAwMDE5OSwibmJmIjoxNjMwMDAwMTk5LCJleHAiOjE2MzAwODY1OTl9` → `{"sub":"XekKekAnon1337","iat":1630000199,"nbf":1630000199,"exp":1630086599}`

Третья часть декодируется в нечто нечитаемое, оставим её на потом.

В первом блоке мы видим два поля — `typ` и `alg`. Если мы загуглим всю эту строку, то наверняка узнаем о том, что эта строка представляет собой [JSON Web Token](https://ru.wikipedia.org/wiki/JSON_Web_Token). Каждый такой токен состоит из трёх частей: заголовка, полезной нагрузки и криптографической подписи.

> Подсказку можно было получить, заменив сессию на что-то непонятное: сервер в таком случае отвечал ошибкой «Ваш cookie-файл не соответствует стандарту JavaScript объектной нотации всемирной паутины жетона».

Все поля в полезной нагрузке стандартны: `sub` задаёт имя пользователя, `iat` (issued at) и `nbf` (not before) — время выдачи токена, `exp` — время истечения срока. Так мы можем узнать, что токен истёк 27 августа 2021 года в 20:49:59 — совсем недавно. Однако, мы можем лишь прочитать содержимое токена, но не модифицировать его, поскольку новые данные также должны быть подписаны, а это сделать без знания секретного ключа сервера невозможно. Ни одной пары логин-пароль мы также не знаем: зайти на сайт и получить свежий токен не выйдет.

Особенностью JWT является довольно сильная универсальность — он поддерживает сразу много алгоритмов подписи из коробки. Например, в исходном токене используется ES256. Можно заметить, что при изменении алгоритма в заголовке ошибки не сильно меняются — сервис всё ещё сообщает о неверной подписи, но не о, как казалось бы и должно быть, некорректном алгоритме. Какие бывают алгоритмы? [Стандарт JWT](https://datatracker.ietf.org/doc/html/rfc7518#section-3) упоминает возможность использовать строку `none` в поле `alg`. Она означает, что токен вообще не будет подписан. Таким образом, если приложение не проверяет, что алгоритм подписи совпадает с ожидаемым, то мы сможем его обмануть.

Убираем подпись, заменяем в заголовке `alg` на `none`. У нас получится следующий cookie:

* `{"typ":"JWT","alg":"none"}` → `eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0=`
* вторая часть такая же: `eyJzdWIiOiJYZWtLZWtBbm9uMTMzNyIsImlhdCI6MTYzMDAwMDE5OSwibmJmIjoxNjMwMDAwMTk5LCJleHAiOjE2MzAwODY1OTl9`

Итоговая сессия: `eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0=.eyJzdWIiOiJYZWtLZWtBbm9uMTMzNyIsImlhdCI6MTYzMDAwMDE5OSwibmJmIjoxNjMwMDAwMTk5LCJleHAiOjE2MzAwODY1OTl9.`

Если установить эту cookie и обновить страницу, то сайт не скажет о некорректной подписи — вернётся прежняя ошибка о том, что cookie-файл истёк. Таким образом мы обошли проверку подписи и можем произвольно менять данные токена.

Для начала попробуем просто перенести `exp` в будущее. Например, на 31 декабря 2021 года 23:59:59 — соответствующий timestamp равен 1640984399.

Вторая часть сессии превратится в `{"sub":"XekKekAnon1337","iat":1630000199,"nbf":1630000199,"exp":1640984399}`, или `eyJzdWIiOiJYZWtLZWtBbm9uMTMzNyIsImlhdCI6MTYzMDAwMDE5OSwibmJmIjoxNjMwMDAwMTk5LCJleHAiOjE2NDA5ODQzOTl9` после кодирования.

После обновления страницы нас встретит новая ошибка — «Ваш cookie-файл не отвечает требованиям по длительности сессии». Она связана с тем, что сайт ограничивает максимальную длину сессии в целях безопасности. Нам придётся обновить и дату выдачи так, что токен будет работать всего один день — 86 400 секунд, как это и было в изначальном токене. После обновления полей `iat`, `nbf` и `exp` нужным образом мы получим флаг.

Флаг: **school_nuclear_such_danger_much_destruction_42fff033e426**
